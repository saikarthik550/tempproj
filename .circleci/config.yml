version: 2.1

jobs:
  cleanup:
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            yum install tar gzip -y
      - run:
          name: Remove old stacks and files
          command: |

            export OldWorkflowID ="   NAME  "
            $OldWorkflowID1 = ${Fn::Trim "$OldWorkflowID"}
            echo $OldWorkflowID  
            echo $OldWorkflowID1
            
              
            if [[ "${CIRCLE_WORKFLOW_ID}" != "${OldWorkflowID}" ]]
            then
              aws s3 rm "s3://udapeople-${OldWorkflowID}" --recursive || true
              aws cloudformation delete-stack --stack-name "udapeople-backend-${OldWorkflowID}" || true
              aws cloudformation delete-stack --stack-name "udapeople-frontend-${OldWorkflowID}" || true
            else
              echo "Stack is the latest"
            fi        
workflows:
  default:
    jobs:
      - cleanup
         
